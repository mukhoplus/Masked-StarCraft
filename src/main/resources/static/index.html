<!DOCTYPE html>
<html lang="ko">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Masked StarCraft Tournament</title>
    <script src="https://cdn.jsdelivr.net/npm/sockjs-client@1/dist/sockjs.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/stompjs@2.3.3/lib/stomp.min.js"></script>
    <style>
      body {
        font-family: Arial, sans-serif;
        max-width: 1200px;
        margin: 0 auto;
        padding: 20px;
        background-color: #f5f5f5;
      }
      .container {
        background-color: white;
        padding: 20px;
        border-radius: 10px;
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        margin-bottom: 20px;
      }
      .refresh-notice {
        background-color: #ffeb3b;
        padding: 15px;
        border-radius: 5px;
        margin-bottom: 20px;
        display: none;
        align-items: center;
        justify-content: space-between;
      }
      .refresh-notice.show {
        display: flex;
      }
      .refresh-btn {
        background-color: #4caf50;
        color: white;
        border: none;
        padding: 10px 20px;
        border-radius: 5px;
        cursor: pointer;
        font-size: 16px;
      }
      .refresh-btn:hover {
        background-color: #45a049;
      }
      .tournament-info {
        margin-bottom: 20px;
      }
      .current-game {
        border-left: 5px solid #2196f3;
        padding-left: 15px;
        margin: 20px 0;
      }
      .game-history {
        margin-top: 30px;
      }
      .game-item {
        background-color: #f9f9f9;
        padding: 10px;
        margin: 5px 0;
        border-radius: 5px;
        border-left: 3px solid #4caf50;
      }
      .websocket-status {
        position: fixed;
        top: 10px;
        right: 10px;
        padding: 5px 10px;
        border-radius: 5px;
        font-size: 12px;
      }
      .connected {
        background-color: #4caf50;
        color: white;
      }
      .disconnected {
        background-color: #f44336;
        color: white;
      }
      .notification {
        background-color: #2196f3;
        color: white;
        padding: 10px;
        margin: 5px 0;
        border-radius: 5px;
        opacity: 0.9;
      }
      .error {
        background-color: #f44336;
        color: white;
        padding: 10px;
        margin: 5px 0;
        border-radius: 5px;
      }
    </style>
  </head>
  <body>
    <div class="websocket-status" id="wsStatus">ì—°ê²° ì¤‘...</div>

    <h1>ğŸ® Masked StarCraft Tournament</h1>

    <div class="refresh-notice" id="refreshNotice">
      <span>ğŸ”„ ëŒ€íšŒ ì§„í–‰ ìƒí™©ì— ë³€í™”ê°€ ìˆìŠµë‹ˆë‹¤!</span>
      <button class="refresh-btn" onclick="refreshTournament()">
        ìƒˆë¡œê³ ì¹¨
      </button>
    </div>

    <div class="container">
      <div id="notifications"></div>

      <div class="tournament-info">
        <h2>í˜„ì¬ ëŒ€íšŒ ìƒí™©</h2>
        <div id="tournamentStatus">ë¡œë”© ì¤‘...</div>
      </div>

      <div id="currentGame" class="current-game" style="display: none">
        <h3>ğŸ”¥ í˜„ì¬ ê²½ê¸°</h3>
        <div id="currentGameInfo"></div>
      </div>

      <div class="game-history" id="gameHistory" style="display: none">
        <h3>ğŸ“œ ê²½ê¸° ê¸°ë¡</h3>
        <div id="gameHistoryList"></div>
      </div>

      <div id="tournamentResult" style="display: none">
        <h3>ğŸ† ëŒ€íšŒ ê²°ê³¼</h3>
        <div id="resultInfo"></div>
      </div>
    </div>

    <script>
      let stompClient = null;
      let isConnected = false;

      function updateConnectionStatus(connected) {
        isConnected = connected;
        const statusEl = document.getElementById("wsStatus");
        if (connected) {
          statusEl.textContent = "ğŸŸ¢ ì—°ê²°ë¨";
          statusEl.className = "websocket-status connected";
        } else {
          statusEl.textContent = "ğŸ”´ ì—°ê²° ëŠê¹€";
          statusEl.className = "websocket-status disconnected";
        }
      }

      function connect() {
        const socket = new SockJS("/ws");
        stompClient = Stomp.over(socket);

        stompClient.connect(
          {},
          function (frame) {
            console.log("Connected: " + frame);
            updateConnectionStatus(true);

            // í† ë„ˆë¨¼íŠ¸ ì—…ë°ì´íŠ¸ êµ¬ë…
            stompClient.subscribe("/topic/tournament", function (message) {
              console.log("Tournament update received:", message.body);
              handleTournamentUpdate(message.body);
            });

            // ìƒˆë¡œê³ ì¹¨ ì•Œë¦¼ êµ¬ë…
            stompClient.subscribe("/topic/refresh", function (message) {
              console.log("Refresh notification received:", message.body);
              showRefreshNotice();
            });

            // ê²Œì„ ê²°ê³¼ êµ¬ë…
            stompClient.subscribe("/topic/game-result", function (message) {
              console.log("Game result received:", message.body);
              showNotification("ê²Œì„ ê²°ê³¼: " + message.body, "notification");
            });

            // ì´ˆê¸° ë°ì´í„° ë¡œë“œ
            loadTournamentData();
          },
          function (error) {
            console.error("WebSocket connection error:", error);
            updateConnectionStatus(false);
            // ì¬ì—°ê²° ì‹œë„
            setTimeout(connect, 5000);
          }
        );
      }

      function handleTournamentUpdate(message) {
        if (message === "tournament_started") {
          showNotification("ğŸ‰ ìƒˆë¡œìš´ ëŒ€íšŒê°€ ì‹œì‘ë˜ì—ˆìŠµë‹ˆë‹¤!", "notification");
          showRefreshNotice();
        } else if (message.startsWith("tournament_finished:")) {
          const winner = message.split(":")[1];
          showNotification(
            "ğŸ† ëŒ€íšŒê°€ ì¢…ë£Œë˜ì—ˆìŠµë‹ˆë‹¤! ìš°ìŠ¹ì: " + winner,
            "notification"
          );
          showRefreshNotice();
        } else {
          showRefreshNotice();
        }
      }

      function showRefreshNotice() {
        document.getElementById("refreshNotice").classList.add("show");
      }

      function hideRefreshNotice() {
        document.getElementById("refreshNotice").classList.remove("show");
      }

      function showNotification(message, type = "notification") {
        const notificationsEl = document.getElementById("notifications");
        const notificationEl = document.createElement("div");
        notificationEl.className = type;
        notificationEl.textContent = message;
        notificationsEl.appendChild(notificationEl);

        // 5ì´ˆ í›„ ì•Œë¦¼ ì œê±°
        setTimeout(() => {
          notificationEl.remove();
        }, 5000);
      }

      function refreshTournament() {
        fetch("/api/v1/tournaments/refresh", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
          },
        })
          .then((response) => response.json())
          .then((data) => {
            if (data.success) {
              displayTournamentData(data.data);
              hideRefreshNotice();
              showNotification(
                "âœ… ëŒ€íšŒ ì •ë³´ê°€ ìƒˆë¡œê³ ì¹¨ë˜ì—ˆìŠµë‹ˆë‹¤!",
                "notification"
              );
            } else {
              showNotification(
                "âŒ ìƒˆë¡œê³ ì¹¨ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: " + data.message,
                "error"
              );
            }
          })
          .catch((error) => {
            console.error("Refresh error:", error);
            showNotification("âŒ ìƒˆë¡œê³ ì¹¨ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.", "error");
          });
      }

      function loadTournamentData() {
        fetch("/api/v1/tournaments/current")
          .then((response) => response.json())
          .then((data) => {
            if (data.success) {
              displayTournamentData(data.data);
            } else {
              document.getElementById("tournamentStatus").textContent =
                data.message || "ì§„í–‰ ì¤‘ì¸ ëŒ€íšŒê°€ ì—†ìŠµë‹ˆë‹¤.";
            }
          })
          .catch((error) => {
            console.error("Error loading tournament data:", error);
            showNotification(
              "âŒ ëŒ€íšŒ ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.",
              "error"
            );
          });
      }

      function displayTournamentData(tournament) {
        const statusEl = document.getElementById("tournamentStatus");
        const currentGameEl = document.getElementById("currentGame");
        const historyEl = document.getElementById("gameHistory");
        const resultEl = document.getElementById("tournamentResult");

        if (!tournament) {
          statusEl.textContent = "ì§„í–‰ ì¤‘ì¸ ëŒ€íšŒê°€ ì—†ìŠµë‹ˆë‹¤.";
          currentGameEl.style.display = "none";
          historyEl.style.display = "none";
          resultEl.style.display = "none";
          return;
        }

        // ëŒ€íšŒ ìƒíƒœ í‘œì‹œ
        const statusMap = {
          PREPARING: "ì¤€ë¹„ ì¤‘",
          IN_PROGRESS: "ì§„í–‰ ì¤‘",
          FINISHED: "ì™„ë£Œë¨",
        };
        statusEl.innerHTML = `<strong>ìƒíƒœ:</strong> ${
          statusMap[tournament.status] || tournament.status
        }`;

        // í˜„ì¬ ê²½ê¸° í‘œì‹œ
        if (tournament.currentGame) {
          currentGameEl.style.display = "block";
          document.getElementById("currentGameInfo").innerHTML = `
                    <div style="font-size: 18px; margin: 10px 0;">
                        <strong>${tournament.currentGame.player1.displayName}</strong> 
                        VS 
                        <strong>${tournament.currentGame.player2.displayName}</strong>
                    </div>
                    <div>ë§µ: <strong>${tournament.currentGame.map.name}</strong></div>
                    <div>ë¼ìš´ë“œ: <strong>${tournament.currentGame.round}</strong></div>
                `;
        } else {
          currentGameEl.style.display = "none";
        }

        // ê²½ê¸° ê¸°ë¡ í‘œì‹œ
        if (tournament.previousGames && tournament.previousGames.length > 0) {
          historyEl.style.display = "block";
          const historyHtml = tournament.previousGames
            .map(
              (game) => `
                    <div class="game-item">
                        <strong>ë¼ìš´ë“œ ${game.round}:</strong> 
                        ${game.winner.displayName} ìŠ¹ (vs ${
                game.loser.displayName
              }) 
                        - ${game.map.name} 
                        ${game.streak ? `[${game.streak}ì—°ìŠ¹]` : ""}
                    </div>
                `
            )
            .join("");
          document.getElementById("gameHistoryList").innerHTML = historyHtml;
        } else {
          historyEl.style.display = "none";
        }

        // ëŒ€íšŒ ê²°ê³¼ í‘œì‹œ
        if (tournament.result) {
          resultEl.style.display = "block";
          let resultHtml = `
                    <div style="font-size: 20px; margin: 15px 0;">
                        ğŸ† <strong>ìš°ìŠ¹ì: ${
                          tournament.result.winner.displayName
                        }</strong>
                        ${
                          tournament.result.winnerStreak
                            ? ` (ìµœì¢… ${tournament.result.winnerStreak}ì—°ìŠ¹)`
                            : ""
                        }
                    </div>
                `;

          if (
            tournament.result.maxStreakPlayers &&
            tournament.result.maxStreakPlayers.length > 0
          ) {
            const maxStreakNames = tournament.result.maxStreakPlayers
              .map((p) => p.displayName)
              .join(", ");
            resultHtml += `
                        <div style="margin: 10px 0;">
                            ğŸ”¥ <strong>ìµœë‹¤ì—°ìŠ¹:</strong> ${maxStreakNames} 
                            (${tournament.result.maxStreak}ì—°ìŠ¹)
                        </div>
                    `;
          }

          document.getElementById("resultInfo").innerHTML = resultHtml;
        } else {
          resultEl.style.display = "none";
        }
      }

      // í˜ì´ì§€ ë¡œë“œ ì‹œ WebSocket ì—°ê²°
      window.addEventListener("load", function () {
        connect();
      });

      // í˜ì´ì§€ ì–¸ë¡œë“œ ì‹œ ì—°ê²° í•´ì œ
      window.addEventListener("beforeunload", function () {
        if (stompClient !== null) {
          stompClient.disconnect();
        }
      });
    </script>
  </body>
</html>
